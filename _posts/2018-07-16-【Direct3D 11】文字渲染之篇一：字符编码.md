---
layout:     page
title:      【Direct3D 11】文字渲染之篇一：字符编码
subtitle:   Unicode, UTF-8, UTF-16, UTF-32
date:       2018-08-5
author:     翼
header-img: image/bg.jpg
catalog: true
tags:
---
## 前言

>FreeType中load glyph image时，需要根据字符编码获取到字形索引(FT_Get_Char_Index)，因此这里解释一下字符编码相关的东西。这里参考了维基百科和阮一峰老师的文章（[字符编码笔记](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)）。不过我觉得，阮一峰老师讲的里面有些概念比较混淆，比如说“UTF-8 编码”，其实应该只是UTF-8 以一种特有的格式存储一个Unicode编码的时候，加了一些bit数据，但是不应该用“编码”这个字眼，UTF-8不是一种编码，Unicode才是。当然，阮一峰老师的文章让我学到了很多，感谢~~~

## 字符编码  
字符编码，就是把人们使用的文字中的那些字符都规定一个数值。比如ASCII编码中，给字符'A'的编码是65，给字符'a'的编码是97。  
可以认为所谓的字符编码就是制定一个标准，标准规定某个字符的编码应该是多少。一般的编码标准，会兼容ASCII编码，即某个字符，比如字符“A”，在这些标准中的编码都是65。

## Unicode
Unicode就是一个编码标准，也可以说是一个字符集，它规定了这个字符集里面的各个字符的编码是多少。  
**请注意**，Unicode规定了每个字符的编码是多少，但是，数值（即编码）在计算机里存储的形式是二进制值（其实一切都是二进制值）。而Unicode并没有规定这些数值应该存储成什么样的二进制值。  
举例来说，汉字“严”的Unicode编码是20005，十六进制表示是0x4E25。要把这一个数值存储到计算机里面，可以有N中方式：
1. 以2个字节存储： ‭0100 1110 0010 0101‬
2. 以3个字节存储： 0000 0000 ‭0100 1110 0010 0101‬
3. 以4个字节存储： 0000 0000 0000 0000 ‭0100 1110 0010 0101‬
4. 以N个字节存储（当然，实际方案不可能这么浪费）。

这就是问题了，Unicode标准没有规定0x4E25应该怎么存储。  
而实际上，Unicode包含那么多字符，他们对应的那么多编码，有些类似0x4E25可以两个字节就足够存储，有些需要三个字节，或一个字节就够。这些问题，都是Unicode本身并没有规定的。  
**既然有所谓的“标准”，那就有所谓的“标准实现”**。上面的问题就导致了Unicode标准的**实现**有多种了。

另外提一下，简体中文的编码GB2312等，和Unicode是没什么关系的。

## UTF-8, UTF-16, UTF-32
如何实现Unicode，即如何存储Unicode那么多编码，不同的实现方式（存储方式）衍生出了UTF-8, UTF-16, UTF-32。  

### UTF-8
UTF-8 是在互联网上使用最广的**一种 Unicode 的实现方式**。  
UTF-8 最大的一个特点，就是它是**一种变长的编码方式**。它可以使用1~4个字节表示一个符号，根据不同的符号的编码而变化字节长度。  
UTF-8 的存储规则很简单，只有二条：  
1. 对于单字节的符号编码，字节的第一位设为0，后面7位为这个符号的 Unicode 码。因此对于英文字母，UTF-8 编码和 ASCII 码是相同的（不仅是编码相同，存储格式也相同）。
2. 对于n字节的符号编码（n > 1），第一个字节的前n位都设为1，第n + 1位设为0，后面字节的前两位一律设为 10 。剩下的没有提及的二进制位，全部为这个符号的 Unicode 码。

Unicode符号范围        |        UTF-8编码方式
(十六进制)             |        （二进制）
----------------------+---------------------------------------------
0000 0000 - 0000 007F | 0xxxxxxx
0000 0080 - 0000 07FF | 110xxxxx 10xxxxxx
0000 0800 - 0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx
0001 0000 - 0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx

跟据上表，解读 UTF-8 编码非常简单。如果一个字节的第一位是0，则这个字节单独就是一个字符；如果第一位是1，则连续有多少个1，就表示当前字符占用多少个字节。  
还是以汉字“严”为例，演示如何实现 UTF-8 编码。  
“严”的 Unicode 编码是0x4E25（100111000100101），根据上表，可以发现0x4E25处在第三行的范围内（0000 0800 - 0000 FFFF），
因此“严”的 UTF-8 存储需要三个字节，即格式是1110xxxx 10xxxxxx 10xxxxxx。然后，从严的最后一个二进制位开始，依次从后向前填入格式中的x，多出的位补0。
这样就得到了，“严”的 UTF-8 存储格式：11100100 10111000 10100101，转换成十六进制就是0xE4B8A5。但是这不能算是“严”字的UTF-8编码，只能说是“严”的Unicode编码的 UTF-8 表示形式。  

可见UTF-8 以8 bits 为一个存储单元，用 1-4 个单元存储一个Unicode编码。  

### UTF-16，UTF-32
UTF-16，UTF-32 和 UTF-8 类似，只不过：  
UTF-16 以 16 bits 为一个存储单元，用 1-2 个单元存储一个Unicode编码。  
UTF-32 以 32 bits 为一个存储单元，用 1 个单元存储一个Unicode编码。

### 后记
总结一下就是：Unicode是一个**字符编码标准**，它定义了一个字符集。而 UTF-8, UTF-16, UTF-32 等等都是实现了这个编码标准，或者说他们明确了Unicode编码的**存储形式**。  
1. UTF-8  : one to four 8-bit units
2. UTF-16 : one or two 16-bit code units
3. UTF-32 : a single 32-bit code unit

上面说的只是编码存储格式，实际存储的时候，还有大小端问题。不过不影响我们理解字符编码Unicode和UTF-8等之间的关系了，在此不提。
