---
layout:         page
title:         【Go】Localhost支持HTTPS之一：SSL证书信任模型
subtitle:       
date:           2019-04-21
author:         翼
header-img: image/bg.jpg
catalog: true
tags:
---

SSL(Secure Sockets Layer), 及其继任者 TLS(Transport Layer Security)是为网络通信提供安全及数据完整性的一种安全协议。TLS和SSL在传输层对网络连接进行加密。大多数人只知道一个事实：为了使自己的网站支持HTTPS，就需要有一个SSL证书并将证书安装在网站上。他们也并不清楚：终端用户SSL证书只是证书链的一部分。

### SSL根证书
根证书，有时候也成为受信任的根（trusted root），是SSL/TLS信任模型的中心。每个浏览器都会有一个root中心：有些浏览器使用自己的root中心，另外一些利用第三方root中心。一个root中心就是一个预先下载到用户设备中的根证书的集合。根证书是很重要的，因为任何用根证书的私钥签名的证书都自动会被浏览器信任。

受信任的根证书（trusted roots）由CAs（Certificate Authorities）所有。CA是一个有资格校验和颁发SSL证书的机构。

### 证书链
有一个问题：浏览器根据什么来决定是否可以信任一个网站的SSL证书呢？当浏览器访问一个网站时，它会先查看该网站的SSL证书并且校验其证书的真实性。浏览器所做的就是循着证书链来校验该网站的SSL证书。

为了说明什么是证书链，我们先看看怎么获得一个有效的SSL证书：我们必须先创建一个CSR（Certificate Signing Request）和一个私钥。最简单的办法就是把CSR发送到一个CA，然后CA用它的根证书的私钥对我们的SSL证书进行签名并送回给我们。

当一个浏览器看到我们的SSL证书时，它会发现我们的证书是由它的信任根证书列表中的某个根证书的私钥签名过的。浏览器信任根证书，它就信任所有由根证书的私钥签名的证书，因此浏览器就会信任我们的SSL证书。这个过程就形成了一个证书链：CA的根证书、网站的终端用户SSL证书。只不过这个例子中的证书链只有两个证书，网站的证书直接指向某个CA的根证书。

从这里可以看到，证书链其实可以称为签名证书链。因为证书链的作用就是让浏览器能一步步通过解密证书的签名，来看这个证书链的最终端是否自己信任的某个根证书。


### 中间证书（Intermediate Certificate）
CA一般不会直接基于它们的根证书来颁发服务器证书（**终端用户SSL证书**）。这通常很危险，因为如果有些错误的情况需要废弃根证书，所有由这个根证书（的私钥）签名的证书都立即不再被信任。

为了隔离开自己，CA通常颁发所谓的中间根证书（intermediate root）。CA用根证书的私钥对中间根证书进行签名。然后再用中间根证书的私钥对终端用户SSL证书进行签名。这个过程可以重复多次，也就是说，可以创建一系列的中间根证书，然后再用最终的中间根证书对终端用户SSL证书进行签名。

### 数字签名的作用
任何时候，浏览器都会同时获取一个SSL证书以及它的公钥。使用公钥，浏览器可以解密数字签名，从而得知这个证书是被哪个证书签名的。比如说，当浏览器访问网站并校验网站的终端用户SSL证书时，它会用该网站提供的公钥去解密证书的数字签名。这时候浏览器可以知道是哪个证书对这个网站的SSL证书签名的，也就是说，浏览器在证书链中前进了一步。浏览器会重复这个步骤：循着这个证书的签名证书链来解密签名，直到浏览器遇到它的信任证书中心中的某个根证书。

如果浏览器不能循着网站的SSl证书的签名证书链回到自己的某个根证书，就不信任此SSL证书。

### Root CA 和 Intermediate CA
到这里，基本就清楚了：一个Root CA（根证书CA）是拥有一个或多个受信任的根证书的CA。也就是说，根证书CA拥有被大多数浏览器的信任证书中心保存的根证书。中间CA（Intermediate CA）并不拥有任何被浏览器保存着的根证书，只不过他们的中间根证书在一个签名证书链中，并且循着这个证书链能找到最终签名的某个受信任的根证书。这也叫“交叉签名”。

### 公钥基础设施： Public Key Infrastructure
上面讨论的由CA、证书链、数字签名等组成的信任模型，本质上就是所谓的公钥基础设施PKI。根据这个，我们就可以知道怎么在一个企业内部部署私有CA和自签名证书。一个企业通过创建一个根证书以及私钥，并且把根证书添加到自己的根证书中心。企业就能用自己的根证书的私钥来自签名它自己的X.509证书，这些证书就能被整个企业内部网络信任。

我们在本地开发环境支持HTTPS，就是基于这个原理。

